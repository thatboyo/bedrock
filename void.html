<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Void Arcade</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
  :root{
    --screen-w: 360px;
    --screen-h: 240px;
    --bg: linear-gradient(135deg, #020208 0%, #0a0a15 50%, #04040a 100%);
    --muted: #9aa3a8;
    --muted-hover: #b8c1c6;
    --accent: #8ef6c1;
    --accent-hover: #a8ffdb;
    --accent-glow: rgba(142,246,193,0.4);
    --purple-strong: rgba(150,85,255,0.3);
    --purple-glow: rgba(150,85,255,0.2);
    --glass-border: rgba(255,255,255,0.12);
    --gradient-accent: linear-gradient(135deg, var(--accent), #6ee7b7, var(--accent-hover));
    --gradient-glass: linear-gradient(135deg, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0.05) 50%, rgba(255,255,255,0.02) 100%);
    --shadow-epic: 0 35px 100px rgba(0,0,0,0.8), 0 15px 60px rgba(150,85,255,0.1);
    --shadow-medium: 0 15px 50px rgba(0,0,0,0.4);
    font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
  }

  body{
    font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    background: var(--bg);
    background-attachment: fixed;
    color: #f8fafc;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    padding: 24px;
    margin: 0;
  }

  /* GBA Image positioned at front center of screen */
  .gba-front{
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 400px;
    max-width: calc(100% - 20px);
    height: auto;
    z-index: 25;
    pointer-events: none;
    user-select: none;
    -webkit-user-drag: none;
    filter: drop-shadow(0 10px 30px rgba(0,0,0,0.5));
  }

  .gba-shell{
    width: 900px;
    max-width: calc(100% - 48px);
    background: var(--gradient-glass);
    border: 1px solid var(--glass-border);
    border-radius: 24px;
    padding: 28px;
    box-shadow: var(--shadow-epic);
    backdrop-filter: blur(30px);
    -webkit-backdrop-filter: blur(30px);
    display: grid;
    grid-template-columns: 1fr 360px;
    gap: 28px;
    align-items: center;
    position: relative;
    animation: grand-entrance 1.2s cubic-bezier(0.23, 1, 0.320, 1);
  }

  @keyframes grand-entrance {
    0% { opacity: 0; transform: translateY(40px) scale(0.95); filter: blur(10px); }
    50% { opacity: 0.8; transform: translateY(10px) scale(0.98); filter: blur(2px); }
    100% { opacity: 1; transform: translateY(0) scale(1); filter: blur(0); }
  }

  .gba-shell::before{
    content:"";
    position:absolute;
    inset:-15px;
    border-radius:28px;
    z-index:-1;
    background: linear-gradient(135deg, var(--purple-strong), var(--purple-glow), rgba(142,246,193,0.1));
    filter: blur(25px);
    pointer-events:none;
    animation: glow-breathe 6s ease-in-out infinite;
  }

  @keyframes glow-breathe {
    0%, 100% { opacity: 0.8; transform: scale(1); }
    50% { opacity: 1; transform: scale(1.05); }
  }

  .gba-frame{
    position: relative;
    height: 420px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 24px;
    overflow: visible;
    background: var(--gradient-glass);
    border: 1px solid rgba(255,255,255,0.06);
    border-radius: 20px;
    backdrop-filter: blur(15px);
    box-shadow: var(--shadow-medium);
  }

  .gba-frame::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: var(--gradient-accent);
    opacity: 0.6;
    border-radius: 20px 20px 0 0;
  }

  .screen{
    width: var(--screen-w);
    height: var(--screen-h);
    background: linear-gradient(135deg, #0a0a12 0%, #16161d 100%);
    border-radius: 12px;
    box-shadow: 
      0 8px 32px rgba(0,0,0,0.6), 
      inset 0 2px 8px rgba(255,255,255,0.05),
      0 0 0 1px rgba(255,255,255,0.08);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--accent);
    font-weight: 700;
    letter-spacing: 1px;
    text-align: center;
    position: relative;
    overflow: hidden;
    z-index: 20;
    background-clip: padding-box;
    border: 1px solid rgba(142,246,193,0.2);
  }

  .screen::after{
    content:"";
    position: absolute;
    inset: 0;
    background-image: linear-gradient(rgba(142,246,193,0.03) 1px, transparent 1px);
    background-size: 100% 3px;
    pointer-events: none;
    mix-blend-mode: overlay;
  }

  .controls{
    display: flex;
    flex-direction: column;
    gap: 20px;
    padding: 20px;
    background: var(--gradient-glass);
    border: 1px solid rgba(255,255,255,0.06);
    border-radius: 20px;
    backdrop-filter: blur(15px);
    box-shadow: var(--shadow-medium);
    z-index: 30;
  }

  .controls::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: var(--gradient-accent);
    opacity: 0.6;
    border-radius: 20px 20px 0 0;
  }

  label{ 
    font-size: 14px; 
    color: var(--accent); 
    font-weight: 600;
    margin-bottom: 8px;
    display: block;
  }

  select, button{
    font-size: 15px;
    padding: 12px 16px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.12);
    outline: none;
    font-family: inherit;
    font-weight: 500;
    transition: all 0.3s ease;
  }

  select{
    background: rgba(0,0,0,0.3);
    color: #f8fafc;
    width: 100%;
    backdrop-filter: blur(10px);
  }

  select:hover, select:focus {
    border-color: rgba(142,246,193,0.4);
    box-shadow: 0 0 20px rgba(142,246,193,0.1);
  }

  .start-row{
    display: flex; 
    gap: 12px; 
    align-items: center;
    flex-wrap: wrap;
  }

  .start-btn{
    background: var(--gradient-accent);
    color: #0a0a0a;
    cursor: pointer;
    padding: 14px 24px;
    font-weight: 800;
    letter-spacing: 0.5px;
    transition: all 0.2s cubic-bezier(.2,.9,.3,1);
    box-shadow: 0 8px 25px rgba(142,246,193,0.3);
    text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    border: none;
  }

  .start-btn:hover {
    transform: translateY(-2px) scale(1.02);
    box-shadow: 0 12px 35px rgba(142,246,193,0.4);
  }

  .start-btn:active{ 
    transform: translateY(1px) scale(0.98); 
    box-shadow: 0 4px 15px rgba(142,246,193,0.2);
  }

  .open-direct{
    background: transparent;
    color: var(--muted);
    text-decoration: underline;
    padding: 8px 12px;
    border: 1px solid rgba(255,255,255,0.1);
    font-size: 13px;
  }

  .open-direct:hover {
    color: var(--accent);
    border-color: rgba(142,246,193,0.3);
    background: rgba(142,246,193,0.05);
  }

  .meta{
    font-size: 13px;
    color: var(--muted);
    font-weight: 500;
  }

  .game-list{
    display: flex; 
    flex-direction: column; 
    gap: 12px;
  }

  .game-entry{
    display: flex; 
    justify-content: space-between; 
    gap: 12px; 
    align-items: center;
    background: rgba(255,255,255,0.04);
    padding: 12px 16px; 
    border-radius: 12px;
    font-size: 14px;
    border: 1px solid rgba(255,255,255,0.06);
    transition: all 0.3s ease;
  }

  .game-entry:hover {
    background: rgba(255,255,255,0.08);
    border-color: rgba(142,246,193,0.2);
    transform: translateY(-1px);
  }

  .note{ 
    font-size: 13px; 
    color: var(--muted);
    line-height: 1.5;
    opacity: 0.8;
  }

  #gameTitle {
    color: #f8fafc;
    font-weight: 600;
  }

  #gamePath {
    font-size: 11px; 
    color: var(--muted);
    font-family: 'Courier New', monospace;
  }

  code {
    background: rgba(0,0,0,0.3);
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 12px;
    color: var(--accent);
    border: 1px solid rgba(142,246,193,0.2);
  }

  @media (max-width:1000px){
    .gba-shell{ 
      grid-template-columns: 1fr; 
      gap: 20px;
    }
    .gba-front {
      width: 320px;
    }
  }

  @media (max-width:600px){
    .gba-shell {
      padding: 20px;
    }
    .screen {
      width: 280px;
      height: 180px;
    }
    .gba-front {
      width: 280px;
    }
  }

  :focus { 
    outline: 2px solid var(--accent-glow); 
    outline-offset: 2px; 
  }

  /* Additional cyberpunk enhancements */
  .controls h3 {
    color: var(--accent);
    font-size: 16px;
    font-weight: 800;
    margin: 0 0 12px 0;
    text-shadow: 0 0 10px rgba(142,246,193,0.3);
  }

  .section-divider {
    height: 1px;
    background: linear-gradient(90deg, transparent, rgba(142,246,193,0.3), transparent);
    margin: 16px 0;
  }
</style>
</head>
<body>
  <div class="gba-shell" role="application" aria-label="Void Arcade GBA hub">
    <div class="gba-frame">
      <!-- GBA image centered over the screen -->
      <img src="GBA.png" alt="GBA shell" class="gba-front">

      <!-- Screen content -->
      <div class="screen" id="screen">
        <div id="screenContent">
          SELECT A GAME
        </div>
      </div>
    </div>

    <div class="controls" aria-hidden="false">
      <div>
        <h3>üéÆ Game Cartridge</h3>
        <label for="gameSelect">Insert cartridge to begin</label>
        <select id="gameSelect" aria-label="Choose game">
          <option value="">‚Äî select game ‚Äî</option>
          <option value="Kirbymirror.html" data-thumb="thumbs/tetris.png">Kirby's Amazing Mirror</option>
          <option value="games/pokemon-red/index.html" data-thumb="thumbs/pokemon-red.png">Pocket Monster: Red</option>
          <option value="games/zelda-minish/index.html" data-thumb="thumbs/zelda-minish.png">Zelda ‚Äî Mini Quest</option>
          <option value="games/mario-kart/index.html" data-thumb="thumbs/mario-kart.png">Mario Kart-ish</option>
        </select>
        <div class="meta note" style="margin-top:12px;">Host game files in the same repo to avoid frame restrictions</div>
      </div>

      <div class="section-divider"></div>

      <div class="start-row">
        <button id="startBtn" class="start-btn" type="button" aria-label="Start game">‚ñ∂ POWER ON</button>
        <button id="openDirect" class="open-direct" type="button" style="display:none">Direct Link</button>
      </div>

      <div class="section-divider"></div>

      <div>
        <h3>üìä System Status</h3>
        <div class="game-list" id="gameInfo">
          <div class="game-entry">
            <div id="gameTitle">No cartridge inserted</div>
            <div id="gamePath" style="font-size:11px; color:var(--muted);">‚Äî</div>
          </div>
        </div>
      </div>

      <div class="section-divider"></div>

      <div>
        <div class="note">System opens games in stealth <code>about:blank</code> tabs with embedded iframes. Falls back to direct links if embedding fails due to security policies.</div>
      </div>
    </div>
  </div>

<script>
(function(){
  const gameSelect = document.getElementById('gameSelect');
  const screen = document.getElementById('screenContent');
  const gameTitle = document.getElementById('gameTitle');
  const gamePath = document.getElementById('gamePath');
  const startBtn = document.getElementById('startBtn');
  const openDirect = document.getElementById('openDirect');

  function escapeHtml(s){
    if(!s) return '';
    return s.replace(/[&<>"']/g, function(c){
      return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]);
    });
  }
  function escapeAttr(s){
    return escapeHtml(s).replace(/\n/g,' ');
  }

  // Update screen display when selection changes
  function updateScreen(){
    const opt = gameSelect.options[gameSelect.selectedIndex];
    const title = opt && opt.text ? opt.text : 'No cartridge inserted';
    // Prefer explicit data-url if present, otherwise use value
    const valRaw = (opt && (opt.dataset && opt.dataset.url)) ? opt.dataset.url : (opt && opt.value ? opt.value : '');
    const val = valRaw ? String(valRaw).trim() : '';
    const thumb = opt && opt.dataset && opt.dataset.thumb ? opt.dataset.thumb : '';

    gameTitle.textContent = title;
    gamePath.textContent = val || '‚Äî';
    if(thumb){
      screen.innerHTML = `<img src="${escapeAttr(thumb)}" alt="${escapeAttr(title)} thumbnail" style="width:100%;height:100%;object-fit:cover;border-radius:8px;">`;
    } else {
      screen.innerHTML = `<div style="padding:6px;font-size:14px;text-shadow:0 0 10px rgba(142,246,193,0.5);">${val ? escapeHtml(title) : 'SELECT A GAME'}</div>`;
    }

    openDirect.style.display = val ? 'inline-block' : 'none';
    openDirect.dataset.url = val || '';
  }

  // Initialize
  gameSelect.addEventListener('change', updateScreen);
  // Also update on focus/blur just in case selection changed by keyboard
  gameSelect.addEventListener('blur', updateScreen);
  updateScreen();

  openDirect.addEventListener('click', () => {
    const url = (openDirect.dataset && openDirect.dataset.url) ? openDirect.dataset.url.trim() : '';
    if(!url) return;
    window.open(url, '_blank', 'noopener');
  });

  // Helper to get the effective URL of currently selected option
  function getSelectedUrl(){
    const opt = gameSelect.options[gameSelect.selectedIndex];
    if(!opt) return '';
    // support data-url attribute as higher priority
    const dataUrl = opt.dataset && opt.dataset.url ? String(opt.dataset.url).trim() : '';
    const valueUrl = opt.value ? String(opt.value).trim() : '';
    return dataUrl || valueUrl || '';
  }

  // Prevent double clicks
  let opening = false;

  startBtn.addEventListener('click', (e) => {
    if(opening) return;
    opening = true;
    try {
      const url = getSelectedUrl();
      const title = gameSelect.options[gameSelect.selectedIndex]?.text?.trim() || 'Game';
      if(!url){
        alert('Insert a game cartridge first!');
        opening = false;
        return;
      }

      // Try to open a blank tab (user gesture). If popup blocked, w will be null.
      const w = window.open('about:blank', '_blank');
      if(!w){
        // friendly guidance for popup-blocked case
        alert('Popup blocked ‚Äî allow popups for this site or use the Direct Link button.');
        console.error('Void Arcade: popup blocked when attempting to open about:blank.');
        opening = false;
        return;
      }

      // Compose the injected page. Keep embed/fallback behavior but with safer checks.
      // IMPORTANT: any literal closing </script> inside this template must be escaped as <\/script>
      // so the outer HTML parser doesn't end the outer script tag prematurely.
      const newTabHtml = `<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>${escapeHtml(title)} ‚Äî Void Arcade</title>
<style>
  html,body{height:100%;margin:0;background:linear-gradient(135deg, #020208 0%, #0a0a15 50%, #04040a 100%);color:#f8fafc;font-family:'Inter',system-ui,Arial;}
  .wrap{display:flex;flex-direction:column;height:100%;}
  header{padding:12px 20px;background:linear-gradient(135deg, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0.05) 100%);backdrop-filter:blur(20px);border-bottom:1px solid rgba(255,255,255,0.1);font-weight:700;color:#8ef6c1;text-shadow:0 0 10px rgba(142,246,193,0.3);position:relative;}
  .frame{flex:1;display:flex;align-items:center;justify-content:center;background:#08111b;}
  iframe{width:100%;height:100%;border:none;}
  .fallback{padding:24px;text-align:center;background:rgba(255,255,255,0.05);border-radius:16px;margin:20px;border:1px solid rgba(255,255,255,0.1);}
  a.btn{display:inline-block;margin-top:16px;padding:12px 20px;border-radius:12px;background:linear-gradient(135deg, #8ef6c1, #6ee7b7);color:#0a0a0a;text-decoration:none;font-weight:700;transition:all 0.2s ease;}
  a.btn:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(142,246,193,0.4);}
  #closeLauncherBtn{position:absolute;right:12px;top:10px;padding:8px 12px;border-radius:10px;background:transparent;border:1px solid rgba(255,255,255,0.08);color:#8ef6c1;cursor:pointer;font-weight:700;}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      üéÆ Void Arcade ‚Äî ${escapeHtml(title)}
      <button id="closeLauncherBtn" title="Close launcher tab (if allowed)">Close Launcher</button>
    </header>
    <div class="frame" id="frame">
      <iframe id="gameframe" src="${escapeAttr(url)}" allowfullscreen sandbox="allow-scripts allow-same-origin allow-forms"></iframe>
    </div>
    <div class="fallback" id="fallback" style="display:none;">
      <div style="color:#8ef6c1;font-weight:600;margin-bottom:12px;">‚ö†Ô∏è Embedding Blocked</div>
      <div>This game cannot be embedded due to security restrictions.</div>
      <a class="btn" href="${escapeAttr(url)}" target="_blank" rel="noopener">üöÄ Open Game Direct</a>
    </div>
  </div>

<script>
  (function(){
    const iframe = document.getElementById('gameframe');
    const fallback = document.getElementById('fallback');
    const closeLauncherBtn = document.getElementById('closeLauncherBtn');

    function showFallback(){
      fallback.style.display = 'block';
    }

    function checkIframeBlocked(){
      try {
        const cw = iframe.contentWindow;
        // try to read a property ‚Äî will throw if cross-origin and disallowed
        setTimeout(() => {
          try {
            const doc = iframe.contentDocument || cw.document;
            // if access succeeds, embedding works (same-origin)
          } catch (err) {
            showFallback();
          }
        }, 700);
      } catch (err) {
        showFallback();
      }
    }

    iframe.addEventListener('load', () => {
      checkIframeBlocked();
      tryCloseOpener();
    });

    function tryCloseOpener(){
      try {
        if(window.opener && !window.opener.closed){
          try { window.opener.focus(); } catch(e) {}
          try { window.opener.close(); } catch(e) {}
        }
      } catch(e){}
    }

    // Retry closing opener a few times (best-effort)
    tryCloseOpener();
    setTimeout(tryCloseOpener, 250);
    setTimeout(tryCloseOpener, 750);

    closeLauncherBtn.addEventListener('click', () => {
      tryCloseOpener();
      try { window.close(); } catch(e) {}
    });

    setInterval(() => {
      try {
        if(!window.opener || window.opener.closed){
          closeLauncherBtn.style.display = 'none';
        }
      } catch(e){}
    }, 700);
  })();
<\/script>
</body>
</html>`; 

      // write the injected page into the new window (this is synchronous enough)
      try {
        w.document.open();
        w.document.write(newTabHtml);
        w.document.close();
        // try to focus the new tab (best-effort)
        try { w.focus(); } catch(e){}
      } catch (err){
        console.error('Void Arcade: error injecting new tab HTML', err);
        alert('An error occurred while launching the game. Check console for details.');
      } finally {
        // allow future opens after a short delay
        setTimeout(() => { opening = false; }, 600);
      }
    } catch (outerErr){
      console.error('Void Arcade: unexpected error in start handler', outerErr);
      opening = false;
    }
  });

})();
</script>
</body>
</html>
